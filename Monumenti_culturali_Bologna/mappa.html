<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa</title>
</head>
<body>
    <!-- definizione stile mappa -->
    <style>
      #mapid { 
        height: 300px; 
        margin-top: 50px;
      }
    </style>

    <!-- inserimento mappa -->

    <div id="mapid"></div>

    <script>
      const latBologna = 44.494887;
      const lonBologna = 11.3426163;
    
      // open street map diventa la base dei dati
      // 1. uso open street map
      const attribution = '&copy; <a href="htts://www.openstreetmap.org/copyright"> OpenStreetMap </a>contributors';
      // 2. formato per open street map per accedere ai dati
      const tUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
      // 3. carico il formato come layer della mappa e lo aggiungo al contenitore della mappa stessa 
      const tiles = L.tileLayer(tUrl, { attribution });

      // Setup della mappa alla posizione di Bologna
      // L= oggetto dell'interfaccia per poter accedere ai metodi, 13 = livello di zoom sulla mappa
      var map = L.map('mapid').setView([latBologna, lonBologna], 13);
      tiles.addTo(map);        

      // al caricare della pagina viene chiamata la funzione "setupstrutture"
      window.addEventListener("load", setupStrutture);

      // scorro a gruppi di due, perch√® ogni 2 indici ho l'info in merito ad ogni struttura
      async function setupStrutture() {
        const strutture = await getStrutture();
        for (let i = 2; i < strutture.markersInfo.length; i += 2) {
          var lon = strutture.markersInfo[i][0];
          var lat = strutture.markersInfo[i][1];
          var descrizione = strutture.markersInfo[i + 1];
          if (!isNaN(lat) && !isNaN(lon)) {
            var markerStruttura = new L.LatLng(lat, lon);
            var marker = new L.Marker(markerStruttura);
            map.addLayer(marker);
            
            marker.bindPopup(descrizione);
          } else {
            console.log("Posizione assente per " + descrizione);
          }
        }
      }

      // chiamata http al sever dove vengono chiesti tutti i dati csv
      async function getStrutture() {
          const response = await fetch("/datacsv");
          const data = await response.text();

          const markersInfo = []; // [lat,lon] vettore
          const rows = data.split("\n"); // Quartiere, Categorie, Denominazione, Descrizione, Indirizzo, Latitudine, Longitudine
          var primaRiga = 0;
          // viene eseguito il parsing del csv
          rows.forEach(row => {
            const cols = row.split(';'); 
            const descrizione = 
              cols[0] + "<br>" +
              cols[1] + "<br>" +
              cols[2] + "<br>" +
              cols[4] + "<br>";

              // popolo la struttura con info di latitudine e longitudine
              markersInfo.push([parseFloat(cols[6]), parseFloat(cols[5])]);
              markersInfo.push(descrizione);
              });
          return { markersInfo };
        }

    </script>
 
</body>
</html>