<!DOCTYPE html >
< html  lang =" it " >
< testa >
    < metacarattere  =" UTF -8 " >
    < meta  http-equiv =" X-UA-Compatible " content =" IE=edge " >
    < meta  name =" viewport " content =" width=device-width, initial-scale=1.0 " >
    < link  href =" https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css "
    rel =" foglio di stile "
    integrità =" sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor "
    crossorigine = " anonimo " >
    < link  rel =" foglio di stile " href =" css/style.css " >
    < link  rel =" foglio di stile " href =" ./style.css " >

    < link  rel =" foglio di stile " href =" https://unpkg.com/leaflet@1.8.0/dist/leaflet.css "
    integrità =" sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ== "
    origine incrociata =""/>
    
    <!-- Assicurati di inserire questo DOPO il CSS del volantino -->
    < script  src =" https://unpkg.com/leaflet@1.8.0/dist/leaflet.js "
    integrità =" sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ== "
    crossorigin ="" > </ script >

    < titolo > Lista Completa </ ​​titolo >

    < stile >
        tabella  td ,
        tavolo  th {
            bordo : 1 px solido # c9c9c9 ;
        }

        th  { _
            imbottitura :  15 px ;
        }

        . btn {
            colore di sfondo : blu;
            colore : bianco fumo;
            margine superiore : 40 px ;
            margine inferiore :  10 px ;
        }

        # ricerca {
            colore di sfondo :  rgb ( 114 ,  149 ,  209 );
            colore : bianco fumo;
            margine-destra :  50 % ;
            margine superiore : 40 px ;
            margine inferiore :  10 px ;
        }

    </ stile >   
  </ testa >
< corpo >
    < h1  style =" text-align:center " > Centri culturali di Bologna </ h1 >
    < p  style =" text-align:center " > Qui di seguito troverai tutte le informazioni sui centri culturali presenti a Bologna </ p >

  < div  class =" contenitore centro testo " >
    < a  href =" /ricerca " class =" btn " id =" ricerca " > Ricerca Struttura </ a >
    < a  href =" / " class =" btn " > Torna alla Home Page </ a >
  </ div >

  < h > Ricerca su colonne (nome, tipo, llocalità </ h >
  < div  class =" contenitore centro testo " >
    
    < input  type =" text " id =" search-Box " placeholder =" search.. " >
  
    <!-- inserimento Tabella -->
    < table  id =" table " style =" margin-top: 20px " >
        < gruppo >
            < col  id =" col " style =" background-color: rgb(180, 217, 250) " >
            < col >
            < col  style =" background-color: rgb(180, 217, 250) " >
            < col >
            < col  style =" background-color: rgb(180, 217, 250) " >
            < ID riga  =" riga " > </ riga >
        </gruppo >
        <thead  style =" background-color: rgb(86, 86, 244) " >
            < tr >
                < th  scope =" col " id =" nome " > Denominazione </ th >
                < th  scope =" col " id =" quartiere " > Quartiere </ th >
                < th  scopo =" col " > Indirizzo </ th >
                < th  scope =" col " id =" categoria " > Categoria </ th >
                < th  scope =" col " > Descrizione </ th >
            </ tr >        
        </ testa >
        < tbody  id =" tabellaDati " > </ tbody >
    </tabel>

    <script>
        
        // al caricamento della pagina viene chiamata la funzione "inserimentoDati"
        finestra . addEventListener ( "carica" ,  inserimentoDati ) ; 

        // chiamata http al server dove vengono chiesti tutti i dati csv
         funzione  asincrona inserimento dati ( )  {
            // acquisizione dei dati
             risposta  const =  await  fetch ( "/datacsv" ) ;
            const  data  =  attendi  risposta . testo ( ) ;

            // vettore di appoggio dei dati acquisiti
             coordinata  cost =  [ ] ;  // [lat,lon]vettore
             righe  cost =  dati . dividi ( "\n" ) ;  // Divisione delle righe del csv
            var  primaRiga  =  0 ;
            var  ultimariga  =  non definito ;
            // viene eseguito il parsing del csv
            righe . forEach ( riga  =>  {
              const  cols  =  riga . dividere ( ',' ) ; 
              const  dati  = 
                cols [ 0 ]  +  "<br>" ;

                if  ( primaRiga  !==  0  &&  ultimariga  ===  non definito ) {
                    // popolo la struttura con info
                    inserimentoInTabella  = 
                      "<td>"  +  colonne [ 0 ]  +  "</td>"  +
                      "<td>"  +  colonne [ 1 ]  +  "</td>"  +
                      "<td>"  +  colonne [ 2 ]  +  "</td>"  +                
                      "<td>"  +  colonne [ 3 ]  +  "</td>"  +
                      "<td>"  +  colonne [ 4 ]  +  "</td>" ;
                    documento . getElementById ( "tabellaDati" ) . innerHTML  +=  inserimentoInTabella ;
                  }
                  primaRiga ++ ;
                } ) ;
                coordinare . bindPopup ( dati ) ;
          }

  /* var searchData = document.getElementById("casella di ricerca");
    
    // stiamo dicendo che la ricerca (evento) viene generato quando
    // viene rilasciata una chiave
    searchData.addEventListener('keyup', function(){
        var parola chiave = this.value;
        console.log(parola chiave);
        parola chiave = parola chiave.toUpperCase();
        // acquisisci la tabella
        var table = document.getElementById(tabellaDati);
        // acquisisci tutte le righe
        var all_tr = table.getElementById(riga);
        // acquisisco il nome di ogni colonna e il testo al suo interno
        for(var i = 0; i < all_tr.lenght; i++){
            var nome_col = all_tr[i].getElementById(nome)[0];
            var quartiere_col = all_tr[i].getElementById(quartiere)[1];
            var categoria_col = all_tr[i].getElementById(categoria)[3];
            
            if(nome_col && quartiere_col && categoria_col){
                  var name_value = nome_colonna.textContent || nome_colonna.testo interno;
                  var quartiere_col = email_column.textContent || email_column.innerText;
                  
                  var valore_nome = valore_nome.toUpperCase();
                  var valore_quartiere = valore_quartiere.toUpperCase();
                  if((nome_valore.indiceOf(parola chiave) > -1) || (quartiere_valore.indiceOf(parola chiave) > -1)){
                    console.log("trovato");
                              //all_tr[i].style.display = ""; // mostrare
                  }altro{
                    //all_tr[i].style.display = "nessuno"; // nascondere
                              console.log("non trovato");
                  }
                }
		}
    });*/
    </script>

    <!----INDEX---->
    <!-- inserimento mappa -->

    <div id="mapid"></div>

    <script>
        const latBologna = 44.494887;
        const lonBologna = 11.3426163;
       
        // open street map diventa la base dei dati
        // 1. uso open street map
        const attribution = '&copy; <a href="htts://www.openstreetmap.org/copyright"> OpenStreetMap </a>contributors';
        // 2. formato per open street map per accedere ai dati
        const tUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
        // 3. carico il formato come layer della mappa e lo aggiungo al contenitore della mappa stessa 
        const tiles = L.tileLayer(tUrl, { attribution });

        // Setup della mappa alla posizione di Bologna
        // L= oggetto dell'interfaccia per poter accedere ai metodi, 13 = livello di zoom sulla mappa
        var map = L.map('mapid').setView([latBologna, lonBologna], 13);
        tiles.addTo(map);        

        // al caricare della pagina viene chiamata la funzione "setupstrutture"
        window.addEventListener("load", setupStrutture);

        // scorro a gruppi di due, perchè ogni 2 indici ho l'info in merito ad ogni struttura
        async function setupStrutture() {
          const strutture = await getStrutture();
          for (let i = 2; i < strutture.markersInfo.length; i += 2) {
            var lon = strutture.markersInfo[i][0];
            var lat = strutture.markersInfo[i][1];
            var descrizione = strutture.markersInfo[i + 1];
            if (!isNaN(lat) && !isNaN(lon)) {
              var markerStruttura = new L.LatLng(lat, lon);
              var marker = new L.Marker(markerStruttura);
              map.addLayer(marker);
              
              marker.bindPopup(descrizione);
            } else {
              console.log("Posizione assente per " + descrizione);
            }
          }
        }

        // chiamata http al sever dove vengono chiesti tutti i dati csv
        async function getStrutture() {
            const response = await fetch("/datacsv");
            const data = await response.text();

            const markersInfo = []; // [lat,lon] vettore
            const rows = data.split("\n"); // Quartiere, Categorie, Denominazione, Descrizione, Indirizzo, Latitudine, Longitudine
            var primaRiga = 0;
            // viene eseguito il parsing del csv
            rows.forEach(row => {
              const cols = row.split(';'); 
              // inserimento nei marker delle info da mostrare
              const descrizione = 
                cols[0] + "<br>" +
                cols[1] + "<br>" +
                cols[2] + "<br>" +
                cols[3];

                // popolo la struttura con info di latitudine e longitudine
                markersInfo.push([parseFloat(cols[6]), parseFloat(cols[5])]);
                markersInfo.push(descrizione);
                });
            return { markersInfo };
          }

    </script>
  </div>

  <p style="margin-top:30px; margin-left: 100px; font-size: 16px;"> Credi che il sito non sia abbastanza aggiornato?<br>
    Qui di seguito avrai la possibilità di gestire al meglio ogni struttura. <br>
    Potrai ricercare le strutture per nome, quartiere o categoria, inserire strutture non presenti sul sito o eliminare quelle che sono state chiuse! </p>

  <div class="container text-center" style="margin-right: 30px;">
    <a href="/new" class="btn" id="insert">Inserisci Struttura</a>
    <a href="/ricerca" class="btn" id="research" >Ricerca Struttura</a>
    <a href="/rimuovi" class="btn" id="remove">Rimuovi Struttura</a>
  </div>


  </div>
</body>
</html>
